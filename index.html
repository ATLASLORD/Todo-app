<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#2d3436">
  <title>To-Do List - Katana Edition</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <script>
    (function() {
      const localTheme = localStorage.getItem('kurz_theme');
      const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (localTheme === 'dark' || (!localTheme && systemDark)) {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    })();
  </script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-base: #dfe6e9; --star-color: 60, 99, 130; 
      --card: #ffffff; --outline: #2d3436; --outline-width: 3px;
      --text: #2d3436; --shadow-col: #2d3436;
      --input-bg: #ffffff; --input-focus: #f0fbff; --empty-bg: rgba(255,255,255,0.5);
      --c-blue: #00cec9; --c-yellow: #fdcb6e; --c-red: #ff7675; --c-green: #00b894;
      --c-dark: #2d3436; --c-grey: #b2bec3;
      --shadow: 6px 6px 0px var(--shadow-col);
    }

    html[data-theme="dark"] {
      --bg-base: #0c121b; --star-color: 255, 255, 255;
      --card: #2f3640; --outline: #dcdde1; --text: #f5f6fa; --shadow-col: #000000;
      --input-bg: #2f3640; --input-focus: #353b48; --empty-bg: rgba(255,255,255,0.05);
      --c-grey: #718093;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html { scrollbar-gutter: stable; overflow-x: hidden; }

    body {
      margin: 0; min-height: 100vh; font-family: 'Nunito', sans-serif;
      color: var(--text); background-color: var(--bg-base);
      display: flex; justify-content: center; padding: 20px;
      padding-top: max(20px, env(safe-area-inset-top));
      padding-bottom: max(20px, env(safe-area-inset-bottom));
      overflow-x: hidden; width: 100%; position: relative;
      transition: background-color 0.3s ease;
    }

    #starfield { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -10; pointer-events: none; }
    #fx-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10000; }
    #clone-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden; }

    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-base); z-index: 20000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
    .login-box { background: var(--card); border: var(--outline-width) solid var(--outline); padding: 30px; text-align: center; max-width: 320px; border-radius: 20px; box-shadow: var(--shadow); }
    .login-title { font-size: 24px; margin-bottom: 20px; font-weight: 900; text-transform: uppercase; }
    .btn-login { background: var(--c-blue); color: white; border: var(--outline-width) solid var(--outline); border-radius: 12px; padding: 12px 24px; font-family: inherit; font-weight: 900; font-size: 16px; cursor: pointer; text-transform: uppercase; width: 100%; box-shadow: 4px 4px 0 var(--shadow-col); }
    .btn-login:active { transform: translate(2px, 2px); box-shadow: none; }

    .app { width: 100%; max-width: 600px; display: none; flex-direction: column; gap: 25px; padding-bottom: 80px; z-index: 1; }
    .app.visible { display: flex; animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .app.shake { animation: screenShake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes screenShake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

    .card { background: var(--card); border: var(--outline-width) solid var(--outline); border-radius: 20px; padding: 20px; box-shadow: var(--shadow); position: relative; z-index: 10; transition: background-color 0.3s ease, border-color 0.3s ease; }
    .header { display: flex; flex-direction: column; gap: 16px; }
    .title-row { display: flex; justify-content: space-between; align-items: center; }
    h1 { margin: 0; font-size: 28px; text-transform: uppercase; letter-spacing: 1px; }
    
    .user-controls { display: flex; gap: 10px; }
    .btn-icon { font-size: 24px; cursor: pointer; user-select: none; transition: transform 0.2s; }
    .btn-icon:active { transform: scale(0.9); }

    .tabs { display: flex; gap: 10px; }
    .btn { border: var(--outline-width) solid var(--outline); border-radius: 12px; background: var(--card); color: var(--text); font-weight: 900; font-family: inherit; cursor: pointer; box-shadow: 4px 4px 0 var(--shadow-col); transition: all 0.1s; text-transform: uppercase; letter-spacing: 0.5px; }
    .btn:active { transform: translate(2px, 2px); box-shadow: 0 0 0 var(--shadow-col); }
    .tab { flex: 1; padding: 14px; font-size: 15px; }
    .tab.active { background: var(--c-yellow); color: #2d3436; transform: translate(2px,2px); box-shadow: 0 0 0 var(--shadow-col); border-color: #2d3436; }

    .input-row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 10px; }
    .task-input { flex: 1; min-width: 200px; height: 54px; background: var(--input-bg); color: var(--text); border: var(--outline-width) solid var(--outline); border-radius: 14px; padding: 0 16px; font-family: inherit; font-weight: 700; font-size: 16px; outline: none; box-shadow: inset 3px 3px 0 rgba(0,0,0,0.1); }
    .actions-row { display: flex; gap: 10px; width: 100%; }
    .lvl-select { display: flex; align-items: center; justify-content: center; gap: 8px; background: var(--card); border: var(--outline-width) solid var(--outline); border-radius: 50px; padding: 5px; height: 54px; flex: 1; box-shadow: 4px 4px 0 var(--shadow-col); }
    .lvl-btn { width: 36px; height: 36px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; transition: transform 0.2s; }
    .lvl-btn.active { border-color: var(--text); transform: scale(1.15); box-shadow: 0 2px 0 rgba(0,0,0,0.3); }
    .l1 { background: var(--c-green); } .l2 { background: var(--c-yellow); } .l3 { background: var(--c-red); }
    
    .btn-add { height: 54px; padding: 0 24px; background: var(--c-blue); color: white; text-shadow: 2px 2px 0 #2d3436; border-color: #2d3436; flex: 1; font-size: 18px; transition: none; }
    .btn-add:active { transform: translate(2px, 2px); box-shadow: 0 0 0 var(--shadow-col); }

    .page { display: none; } .page.active { display: block; }
    .list-container { display: flex; flex-direction: column; min-height: 100px; padding-top: 10px; }

    /* TASK ITEM */
    .task-item { 
      display: flex; align-items: center; 
      background: var(--card); border: var(--outline-width) solid var(--outline); border-radius: 16px; 
      padding: 8px 8px 8px 12px; 
      gap: 10px; 
      box-shadow: 5px 5px 0 rgba(0,0,0,0.2); 
      position: relative; 
      transition: max-height 0.5s ease, margin-bottom 0.5s ease, padding 0.5s ease, border-width 0.4s ease, opacity 0.1s ease; 
      max-height: 120px; margin-bottom: 10px; opacity: 1; 
      transform-origin: center; overflow: visible; z-index: 1; 
      touch-action: pan-y;
    }
    
    .sortable-chosen { background: var(--input-focus) !important; transform: scale(1.02); box-shadow: 8px 8px 0 rgba(0,0,0,0.3) !important; z-index: 100 !important; }
    .sortable-drag { opacity: 0; }
    .task-item.new-entry { animation: cardPopIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
    @keyframes cardPopIn { 0% { opacity: 0; transform: scale(0.5) translateY(20px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
    .task-item.cut-hidden { opacity: 0 !important; pointer-events: none; }
    .task-item.collapsed { max-height: 0 !important; margin-bottom: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; border-width: 0 !important; overflow: hidden; }

    /* CHECKBOX */
    .check-box { width: 48px; height: 48px; border: 3px solid var(--outline); border-radius: 12px; cursor: pointer; display: grid; place-items: center; background: var(--card); transition: transform 0.1s; flex-shrink: 0; position: relative; z-index: 5; }
    .check-box:active { transform: scale(0.9); }
    .check-box svg { width: 24px; opacity: 0; transition: 0.2s; stroke: var(--text); stroke-width: 4px; stroke-linecap: round; stroke-linejoin: round;}
    .check-box.checked { background: var(--c-green); pointer-events: none; border-color: var(--outline); }
    .check-box.checked svg { opacity: 1; transform: scale(1.2); stroke: white; }

    .task-txt { flex: 1; font-weight: 800; font-size: 16px; z-index: 5; word-break: break-word; min-width: 0; margin-right: 2px; }

    .right-col { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; flex-shrink: 0; width: 24px; }
    .task-tag { width: 14px; height: 14px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); z-index: 5; flex-shrink: 0; }

    .btn-delete { color: var(--c-red); font-size: 22px; font-weight: 900; cursor: pointer; line-height: 1; transition: transform 0.2s; display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; }
    .btn-delete:active { transform: scale(1.2); }

    .clone-half { position: absolute; z-index: 9999; background: var(--card); border: var(--outline-width) solid var(--outline); border-radius: 16px; padding: 12px; display: flex; align-items: center; gap: 12px; filter: drop-shadow(5px 5px 0px rgba(0,0,0,0.2)); pointer-events: none; box-sizing: border-box; color: var(--text); overflow: visible !important; }
    
    /* SLASH GLOW EFFECT */
    .slash-flash { 
      position: absolute; 
      height: 6px; 
      background: linear-gradient(90deg, transparent, #fff, transparent);
      box-shadow: 0 0 20px #fff, 0 0 40px #00cec9, 0 0 60px #00cec9;
      z-index: 10000; 
      transform-origin: left center; 
      pointer-events: none; 
      border-radius: 10px;
      filter: brightness(1.5);
    }

    .aura-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: -1; }
    .aura-base { opacity: 0; animation: fadeInBase 1s ease-out 0.3s forwards; }
    @keyframes fadeInBase { to { opacity: 1; } }
    .aura-dot { position: absolute; background-color: var(--c-dot); opacity: 0; border: 1px solid rgba(0,0,0,0.1); animation: driftOut linear infinite; }
    .aura-dot.sq { border-radius: 2px; }
    @keyframes driftOut { 0% { transform: translate(0, 0) scale(0.2); opacity: 0; } 10% { opacity: 0.8; } 100% { transform: translate(var(--tx), var(--ty)) scale(1.2); opacity: 0; } }

    .empty-msg { text-align: center; color: var(--c-grey); font-weight: 800; padding: 40px 20px; border: 2px dashed var(--outline); border-radius: 16px; animation: fadeInMsg 0.5s ease-out; background: var(--empty-bg); }
    @keyframes fadeInMsg { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .history-years { display: flex; gap: 10px; overflow-x: auto; padding: 10px 4px 15px 4px; margin-bottom: 10px; scrollbar-width: none; }
    .history-years::-webkit-scrollbar { display: none; }
    .year-chip { padding: 8px 16px; border-radius: 20px; border: 2px solid var(--outline); background: var(--card); font-weight: 900; font-size: 14px; cursor: pointer; white-space: nowrap; color: var(--text); transition: all 0.2s; flex-shrink: 0; }
    .year-chip.selected { background: var(--text); color: var(--bg-base); }
    
    .history-stats { display: flex; gap: 10px; margin-bottom: 15px; font-size: 13px; font-weight: 800; color: var(--c-grey); justify-content: center; flex-wrap: wrap; }
    .stat-pill { display: flex; align-items: center; gap: 8px; background: var(--input-bg); padding: 6px 12px; border-radius: 12px; border: 2px solid var(--outline); }
    .stat-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; border: 1px solid rgba(0,0,0,0.1); }

    .history-list { display: flex; flex-direction: column; gap: 8px; }
    .h-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; border: 2px solid var(--outline); border-radius: 12px; background: var(--card); animation: fadeInHistory 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); gap: 10px; }
    .h-item.hard { border-color: var(--c-red); background: rgba(255, 118, 117, 0.15); }
    @keyframes fadeInHistory { to { opacity: 1; transform: translateY(0); } }
    
    .h-left { display: flex; flex-direction: column; flex: 1; min-width: 0; }
    .h-date { font-size: 11px; color: var(--c-grey); font-weight: 700; margin-bottom: 2px; }
    .h-txt { font-weight: 800; font-size: 14px; color: var(--text); overflow-wrap: break-word; }
    .h-right { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; flex-shrink: 0; }
    .h-dur { font-size: 10px; font-weight: 900; color: var(--c-grey); background: var(--bg-base); padding: 2px 6px; border-radius: 6px; white-space: nowrap; }
    .h-dot { width: 8px; height: 8px; border-radius: 50%; box-shadow: 0 0 4px currentColor; }
  </style>
</head>
<body>

<canvas id="starfield"></canvas>
<canvas id="fx-canvas"></canvas>
<div id="clone-layer"></div>

<div id="login-overlay">
  <div class="login-box">
    <div class="login-title">TO-DO LIST</div>
    <div style="font-weight: 800; color: var(--c-grey); margin-bottom: 20px;">CONNEXION REQUISE</div>
    <button class="btn-login" onclick="login()">Se connecter (Google)</button>
  </div>
</div>

<div class="app" id="app">
  <div class="card header">
    <div class="title-row">
      <h1>Missions</h1>
      <div class="user-controls">
        <div class="theme-toggle btn-icon" onclick="toggleTheme()">ðŸŒ“</div>
        <div class="theme-toggle btn-icon" onclick="logout()">ðŸšª</div>
      </div>
    </div>
    <div class="tabs">
      <button id="tab-tasks" class="btn tab active" onclick="nav('tasks')">Missions</button>
      <button id="tab-history" class="btn tab" onclick="nav('history')">Archives</button>
    </div>
  </div>

  <div id="page-tasks" class="page active">
    <div class="card">
      <form class="input-row" onsubmit="event.preventDefault(); add();">
        <input type="text" id="inp" class="task-input" placeholder="Nouvelle mission..." autocomplete="off" />
        <div class="actions-row">
          <div class="lvl-select">
            <div class="lvl-btn l1 active" onclick="setLvl(1)"></div>
            <div class="lvl-btn l2" onclick="setLvl(2)"></div>
            <div class="lvl-btn l3" onclick="setLvl(3)"></div>
          </div>
          <button type="submit" class="btn btn-add">Ajouter</button>
        </div>
      </form>
      <div id="list" class="list-container"></div>
    </div>
  </div>

  <div id="page-history" class="page">
    <div class="card">
      <div id="history-content"></div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDn0f67RRq48f_oJMn07PO5_RFkd1o15-c",
    authDomain: "todolist-f1ea8.firebaseapp.com",
    databaseURL: "https://todolist-f1ea8-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "todolist-f1ea8",
    storageBucket: "todolist-f1ea8.firebasestorage.app",
    messagingSenderId: "54632201976",
    appId: "1:54632201976:web:ec4c9785dc9846d4d4c50d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  let tasks = [];
  let currentLvl = 1;
  let currentUser = null;
  let unsubscribeDB = null;

  // --- AUDIO ---
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const buffers = {};

  async function loadSound(name, url) {
    try {
      const response = await fetch(url);
      const arrayBuffer = await response.arrayBuffer();
      const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
      buffers[name] = audioBuffer;
    } catch (e) { console.log("Erreur son:", name); }
  }

  loadSound('katana', 'SFX_Feedback_Hit_Weakness_06.mp3');
  loadSound('whip', 'tinyWhip.mp3');
  loadSound('dwop', 'dwop.mp3');

  function playSoundBuffer(name) {
    if (!buffers[name]) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const source = audioCtx.createBufferSource();
    source.buffer = buffers[name];
    source.connect(audioCtx.destination);
    source.start(0);
  }

  // --- FX CANVAS (CONFETTIS CORRIGÃ‰S) ---
  const fxCanvas = document.getElementById('fx-canvas');
  const fxCtx = fxCanvas.getContext('2d');
  let particles = [];
  
  function resizeFxCanvas() { fxCanvas.width = window.innerWidth; fxCanvas.height = window.innerHeight; }
  window.addEventListener('resize', resizeFxCanvas); resizeFxCanvas();

  class Particle {
    constructor(x, y, color) {
        this.x = x; this.y = y;
        this.color = color;
        this.size = Math.random() * 8 + 4;
        this.isSquare = Math.random() > 0.5;
        const angle = Math.random() * Math.PI * 2;
        const force = Math.random() * 12 + 4;
        this.vx = Math.cos(angle) * force;
        this.vy = Math.sin(angle) * force;
        this.life = 1.0;
        this.gravity = 0.4;
        this.friction = 0.96;
        this.rotation = Math.random() * 360;
        this.rotSpeed = (Math.random() - 0.5) * 15;
    }
    update() {
        this.vx *= this.friction;
        this.vy *= this.friction;
        this.vy += this.gravity;
        this.x += this.vx;
        this.y += this.vy;
        this.life -= 0.02;
        this.rotation += this.rotSpeed;
    }
    draw() {
        fxCtx.save();
        fxCtx.translate(this.x, this.y);
        fxCtx.rotate(this.rotation * Math.PI / 180);
        fxCtx.globalAlpha = this.life;
        fxCtx.fillStyle = this.color;
        if (this.isSquare) {
            fxCtx.fillRect(-this.size/2, -this.size/2, this.size, this.size);
        } else {
            fxCtx.beginPath();
            fxCtx.arc(0, 0, this.size/2, 0, Math.PI * 2);
            fxCtx.fill();
        }
        fxCtx.restore();
    }
  }

  function loopFx() {
    fxCtx.clearRect(0, 0, fxCanvas.width, fxCanvas.height);
    for (let i = particles.length - 1; i >= 0; i--) {
        particles[i].update();
        particles[i].draw();
        if (particles[i].life <= 0) particles.splice(i, 1);
    }
    requestAnimationFrame(loopFx);
  }
  loopFx();

  function spawnCanvasParticles(x, y, isLine = false) {
    const colors = ['#00cec9', '#fdcb6e', '#ff7675', '#00b894', '#f5f6fa'];
    const count = isLine ? 40 : 20;
    for (let i = 0; i < count; i++) {
        let px = x, py = y;
        if (isLine) {
            px = x + (Math.random() - 0.5) * 250;
            py = y + (Math.random() - 0.5) * 30;
        }
        particles.push(new Particle(px, py, colors[Math.floor(Math.random()*colors.length)]));
    }
  }

  // --- LOGIQUE APP ---
  window.login = () => signInWithPopup(auth, provider);
  window.logout = () => signOut(auth).then(() => window.location.reload());

  onAuthStateChanged(auth, (user) => {
    const overlay = document.getElementById('login-overlay');
    const appUI = document.getElementById('app');
    if (user) {
      currentUser = user;
      overlay.style.opacity = '0';
      setTimeout(() => { overlay.style.display = 'none'; appUI.classList.add('visible'); }, 500);
      unsubscribeDB = onValue(ref(db, `users/${user.uid}/todos`), (snap) => {
        tasks = snap.val() || [];
        renderList();
        if(document.getElementById('page-history').classList.contains('active')) renderHistory();
      });
    } else {
      overlay.style.display = 'flex';
      overlay.style.opacity = '1';
    }
  });

  function save() { if(currentUser) set(ref(db, `users/${currentUser.uid}/todos`), tasks); }

  window.add = function() {
    const inp = document.getElementById('inp');
    const txt = inp.value.trim();
    if (!txt) return;
    playSoundBuffer('dwop');
    tasks.unshift({ id: Date.now(), txt, lvl: currentLvl, created: Date.now(), done: null });
    save();
    inp.value = '';
  };

  window.check = function(id, btn) {
    const row = document.getElementById('task-' + id);
    if(!row) return;
    playSoundBuffer('katana');
    btn.classList.add('checked');
    
    const appEl = document.getElementById('app');
    appEl.classList.remove('shake'); void appEl.offsetWidth; appEl.classList.add('shake');

    const rect = row.getBoundingClientRect();
    const layer = document.getElementById('clone-layer');
    const c1 = row.cloneNode(true); const c2 = row.cloneNode(true);

    [c1, c2].forEach(c => {
      c.id = ""; c.style.position = "fixed"; c.style.margin = "0";
      c.style.width = rect.width + "px"; c.style.height = rect.height + "px";
      c.style.left = rect.left + "px"; c.style.top = rect.top + "px";
      c.style.transition = "all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1)";
    });

    c1.style.clipPath = "polygon(0 0, 100% 0, 100% 45%, 0 55%)";
    c2.style.clipPath = "polygon(0 55%, 100% 45%, 100% 100%, 0 100%)";

    layer.appendChild(c1); layer.appendChild(c2);
    row.classList.add('cut-hidden');
    
    spawnSlashLine(rect);
    spawnCanvasParticles(rect.left + rect.width/2, rect.top + rect.height/2, true);

    requestAnimationFrame(() => {
        void c1.offsetWidth;
        c1.style.transform = "translate(-30px, -20px) rotate(-5deg)"; c1.style.opacity = "0";
        c2.style.transform = "translate(30px, 20px) rotate(5deg)"; c2.style.opacity = "0";
    });

    setTimeout(() => { 
        c1.remove(); c2.remove(); row.classList.add('collapsed');
        const idx = tasks.findIndex(t => t.id === id);
        if(idx > -1) { tasks[idx].done = Date.now(); save(); }
    }, 700);
  };

  function spawnSlashLine(rect) {
    const flash = document.createElement('div');
    flash.className = 'slash-flash';
    const w = rect.width * 1.3;
    flash.style.width = w + 'px';
    flash.style.left = (rect.left - (w-rect.width)/2) + 'px';
    flash.style.top = (rect.top + rect.height/2) + 'px';
    flash.style.transform = `rotate(-3deg) scaleX(0)`;
    document.getElementById('clone-layer').appendChild(flash);
    
    flash.animate([
        { transform: 'rotate(-3deg) scaleX(0)', opacity: 0 },
        { transform: 'rotate(-3deg) scaleX(1)', opacity: 1, offset: 0.2 },
        { transform: 'rotate(-3deg) scaleX(1)', opacity: 0 }
    ], { duration: 400, easing: 'ease-out' }).onfinish = () => flash.remove();
  }

  window.del = (id) => {
    playSoundBuffer('whip');
    if(confirm("Supprimer mission ?")) { tasks = tasks.filter(t => t.id !== id); save(); }
  };

  function renderList() {
    const list = document.getElementById('list');
    const active = tasks.filter(t => !t.done);
    list.innerHTML = active.length ? '' : '<div class="empty-msg">Le vide est une mission en soi.</div>';
    active.forEach(t => {
      const el = document.createElement('div');
      el.className = (Date.now() - t.created < 1000) ? 'task-item new-entry' : 'task-item';
      el.id = 'task-' + t.id;
      const color = t.lvl===1 ? 'var(--c-green)' : (t.lvl===2 ? 'var(--c-yellow)' : 'var(--c-red)');
      el.innerHTML = `
        <div class="aura-container aura-base" style="--c-dot: ${color}">${getAuraDots()}</div>
        <div class="check-box" onclick="check(${t.id}, this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 6L9 17L4 12"></path></svg></div>
        <div class="task-txt">${escape(t.txt)}</div>
        <div class="right-col">
          <div class="btn-delete" onclick="del(${t.id})">&times;</div>
          <div class="task-tag" style="background:${color}"></div>
        </div>`;
      list.appendChild(el);
    });
    new Sortable(list, { animation: 150, delay: 200, onEnd: () => {
      const ids = Array.from(list.children).map(c => parseInt(c.id.split('-')[1]));
      const done = tasks.filter(t => t.done);
      tasks = [...ids.map(id => tasks.find(t => t.id === id)), ...done];
      save();
    }});
  }

  function getAuraDots() {
    let h = '';
    for(let i=0; i<10; i++) {
        const tx = (Math.random()-0.5)*40; const ty = (Math.random()-0.5)*40;
        h += `<div class="aura-dot" style="top:${Math.random()*100}%;left:${Math.random()*100}%;width:8px;height:8px;--tx:${tx}px;--ty:${ty}px;animation-delay:-${Math.random()*2}s"></div>`;
    }
    return h;
  }

  window.nav = (p) => {
    playSoundBuffer('whip');
    document.querySelectorAll('.page, .tab').forEach(el => el.classList.remove('active'));
    document.getElementById('page-'+p).classList.add('active');
    document.getElementById('tab-'+p).classList.add('active');
    if(p === 'history') renderHistory();
  };

  window.setLvl = (n) => {
    playSoundBuffer('whip');
    currentLvl = n;
    document.querySelectorAll('.lvl-btn').forEach((b, i) => b.classList.toggle('active', i === n-1));
  };

  window.renderHistory = () => {
    const box = document.getElementById('history-content');
    const done = tasks.filter(t => t.done).sort((a,b) => b.done - a.done);
    if(!done.length) { box.innerHTML = '<div class="empty-msg">Aucune archive.</div>'; return; }
    box.innerHTML = '<div class="history-list"></div>';
    done.forEach(t => {
        const row = document.createElement('div');
        row.className = 'h-item';
        row.innerHTML = `<div class="h-left"><div class="h-date">${new Date(t.done).toLocaleDateString()}</div><div class="h-txt">${escape(t.txt)}</div></div><div class="btn-delete" onclick="del(${t.id})">&times;</div>`;
        box.firstChild.appendChild(row);
    });
  };

  window.toggleTheme = () => {
    const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('kurz_theme', next);
    playSoundBuffer('whip');
  };

  function escape(s) { return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

  // --- STARFIELD ---
  const sCanvas = document.getElementById('starfield');
  const sCtx = sCanvas.getContext('2d');
  let stars = [];
  function initStars() {
    sCanvas.width = window.innerWidth; sCanvas.height = window.innerHeight;
    stars = Array.from({length: 100}, () => ({x: Math.random()*sCanvas.width, y: Math.random()*sCanvas.height, s: Math.random()*2}));
  }
  function animStars() {
    sCtx.clearRect(0,0,sCanvas.width,sCanvas.height);
    const rgb = getComputedStyle(document.body).getPropertyValue('--star-color');
    sCtx.fillStyle = `rgba(${rgb}, 0.5)`;
    stars.forEach(s => { sCtx.beginPath(); sCtx.arc(s.x, s.y, s.s, 0, 7); sCtx.fill(); s.y -= 0.2; if(s.y<0) s.y=sCanvas.height; });
    requestAnimationFrame(animStars);
  }
  window.addEventListener('resize', initStars); initStars(); animStars();
</script>
</body>
</html>