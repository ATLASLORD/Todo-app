<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#2d3436">
  <title>To-Do List</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">

  <script>
    (function() {
      const localTheme = localStorage.getItem('kurz_theme');
      const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (localTheme === 'dark' || (!localTheme && systemDark)) {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    })();
  </script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&display=swap" rel="stylesheet">
  
  <style>
    /* =========================================
       THEME FLAT DESIGN
       ========================================= */
    :root {
      --bg-base: #dfe6e9; --star-color: 60, 99, 130; 
      --card: #ffffff; --outline: #2d3436; --outline-width: 3px;
      --text: #2d3436; --shadow-col: #2d3436;
      --input-bg: #ffffff; --input-focus: #f0fbff; --empty-bg: rgba(255,255,255,0.5);
      --c-blue: #00cec9; --c-yellow: #fdcb6e; --c-red: #ff7675; --c-green: #00b894;
      --c-dark: #2d3436; --c-grey: #b2bec3;
      --shadow: 6px 6px 0px var(--shadow-col);
    }

    html[data-theme="dark"] {
      --bg-base: #0c121b; --star-color: 255, 255, 255;
      --card: #2f3640; --outline: #dcdde1; --text: #f5f6fa; --shadow-col: #000000;
      --input-bg: #2f3640; --input-focus: #353b48; --empty-bg: rgba(255,255,255,0.05);
      --c-grey: #718093;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html { scrollbar-gutter: stable; }

    body {
      margin: 0; min-height: 100vh; font-family: 'Nunito', sans-serif;
      color: var(--text); background-color: var(--bg-base);
      display: flex; justify-content: center; padding: 20px;
      padding-top: max(20px, env(safe-area-inset-top));
      padding-bottom: max(20px, env(safe-area-inset-bottom));
      overflow-y: auto; overscroll-behavior-y: none;
      transition: background-color 0.3s ease;
    }

    #starfield { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -10; pointer-events: none; }

    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-base); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
    .login-box { background: var(--card); border: var(--outline-width) solid var(--outline); padding: 30px; text-align: center; max-width: 320px; border-radius: 20px; box-shadow: var(--shadow); }
    .login-title { font-size: 24px; margin-bottom: 20px; font-weight: 900; text-transform: uppercase; }
    .btn-login { background: var(--c-blue); color: white; border: var(--outline-width) solid var(--outline); border-radius: 12px; padding: 12px 24px; font-family: inherit; font-weight: 900; font-size: 16px; cursor: pointer; text-transform: uppercase; width: 100%; box-shadow: 4px 4px 0 var(--shadow-col); }
    .btn-login:active { transform: translate(2px, 2px); box-shadow: none; }

    .app { width: 100%; max-width: 600px; display: none; flex-direction: column; gap: 25px; padding-bottom: 80px; z-index: 1; }
    .app.visible { display: flex; animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .app.shake { animation: screenShake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes screenShake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

    .card { background: var(--card); border: var(--outline-width) solid var(--outline); border-radius: 20px; padding: 20px; box-shadow: var(--shadow); position: relative; z-index: 10; transition: background-color 0.3s ease, border-color 0.3s ease; }
    .header { display: flex; flex-direction: column; gap: 16px; }
    .title-row { display: flex; justify-content: space-between; align-items: center; }
    h1 { margin: 0; font-size: 28px; text-transform: uppercase; letter-spacing: 1px; }
    
    .user-controls { display: flex; gap: 10px; }
    .btn-icon { font-size: 24px; cursor: pointer; user-select: none; transition: transform 0.2s; }
    .btn-icon:active { transform: scale(0.9); }

    .tabs { display: flex; gap: 10px; }
    .btn { border: var(--outline-width) solid var(--outline); border-radius: 12px; background: var(--card); color: var(--text); font-weight: 900; font-family: inherit; cursor: pointer; box-shadow: 4px 4px 0 var(--shadow-col); transition: all 0.1s; text-transform: uppercase; letter-spacing: 0.5px; }
    .btn:active { transform: translate(2px, 2px); box-shadow: 0 0 0 var(--shadow-col); }
    .tab { flex: 1; padding: 14px; font-size: 15px; }
    .tab.active { background: var(--c-yellow); color: #2d3436; transform: translate(2px,2px); box-shadow: 0 0 0 var(--shadow-col); border-color: #2d3436; }

    .input-row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 10px; }
    .task-input { flex: 1; min-width: 200px; height: 54px; background: var(--input-bg); color: var(--text); border: var(--outline-width) solid var(--outline); border-radius: 14px; padding: 0 16px; font-family: inherit; font-weight: 700; font-size: 16px; outline: none; box-shadow: inset 3px 3px 0 rgba(0,0,0,0.1); }
    .actions-row { display: flex; gap: 10px; width: 100%; }
    .lvl-select { display: flex; align-items: center; justify-content: center; gap: 8px; background: var(--card); border: var(--outline-width) solid var(--outline); border-radius: 50px; padding: 5px; height: 54px; flex: 1; box-shadow: 4px 4px 0 var(--shadow-col); }
    .lvl-btn { width: 36px; height: 36px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; transition: transform 0.2s; }
    .lvl-btn.active { border-color: var(--text); transform: scale(1.15); box-shadow: 0 2px 0 rgba(0,0,0,0.3); }
    .l1 { background: var(--c-green); } .l2 { background: var(--c-yellow); } .l3 { background: var(--c-red); }
    
    .btn-add { 
      height: 54px; padding: 0 24px; 
      background: var(--c-blue); color: white; 
      text-shadow: 2px 2px 0 #2d3436; border-color: #2d3436; 
      flex: 1; font-size: 18px; 
      transition: none; 
    }
    .btn-add:active { transform: translate(2px, 2px); box-shadow: 0 0 0 var(--shadow-col); }

    @media (max-width: 500px) { body { padding: 10px; } .app { gap: 20px; } .input-row { flex-direction: column; } .task-input { width: 100%; } .actions-row { display: flex; } .task-item:hover { transform: none; } }

    .page { display: none; } .page.active { display: block; }
    .list-container { display: flex; flex-direction: column; min-height: 100px; padding-top: 10px; }

    /* --- TASK ITEM COMPACT --- */
    .task-item { 
      display: flex; align-items: center; 
      background: var(--card); 
      border: var(--outline-width) solid var(--outline); 
      border-radius: 16px; 
      padding: 8px 12px;
      gap: 12px; 
      box-shadow: 5px 5px 0 rgba(0,0,0,0.2); 
      position: relative; 
      transition: max-height 0.5s ease, margin-bottom 0.5s ease, padding 0.5s ease, border-width 0.4s ease, opacity 0.1s ease; 
      max-height: 120px; 
      margin-bottom: 10px;
      opacity: 1; 
      transform-origin: center; overflow: visible; z-index: 1; 
      touch-action: manipulation; 
    }

    .task-item.new-entry { animation: cardPopIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
    @keyframes cardPopIn { 0% { opacity: 0; transform: scale(0.5) translateY(20px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
    .task-item.cut-hidden { opacity: 0 !important; pointer-events: none; }
    .task-item.collapsed { max-height: 0 !important; margin-bottom: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; border-width: 0 !important; overflow: hidden; }

    .check-box { width: 48px; height: 48px; border: 3px solid var(--outline); border-radius: 14px; cursor: pointer; display: grid; place-items: center; background: var(--card); transition: transform 0.1s; flex-shrink: 0; position: relative; z-index: 5; }
    .check-box:active { transform: scale(0.9); }
    .check-box svg { width: 30px; opacity: 0; transition: 0.2s; stroke: var(--text); stroke-width: 4px; stroke-linecap: round; stroke-linejoin: round;}
    .check-box.checked { background: var(--c-green); pointer-events: none; border-color: var(--outline); }
    .check-box.checked svg { opacity: 1; transform: scale(1.2); stroke: white; }

    .task-txt { flex: 1; font-weight: 800; font-size: 16px; z-index: 5; word-break: break-word; }
    .task-tag { font-size: 11px; font-weight: 900; text-transform: uppercase; padding: 4px 8px; border-radius: 6px; border: 2px solid var(--outline); white-space: nowrap; z-index: 5; color: #2d3436; }

    .clone-half { position: fixed; z-index: 9999; background: var(--card); border: var(--outline-width) solid var(--outline); border-radius: 16px; padding: 12px; display: flex; align-items: center; gap: 12px; filter: drop-shadow(5px 5px 0px rgba(0,0,0,0.2)); pointer-events: none; box-sizing: border-box; color: var(--text); overflow: visible !important; }
    .slash-flash { position: fixed; height: 4px; background: white; box-shadow: 0 0 10px rgba(255,255,255,0.9), 0 0 20px cyan; z-index: 10000; transform-origin: left center; pointer-events: none; border-radius: 10px; }

    .aura-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: -1; }
    .aura-base { opacity: 0; animation: fadeInBase 1s ease-out 0.3s forwards; }
    @media (hover: hover) { .aura-turbo { opacity: 0; transition: opacity 0.6s ease-out; } .task-item:hover .aura-turbo { opacity: 1; } }
    @media (hover: none) { .aura-turbo { display: none; } }
    @keyframes fadeInBase { to { opacity: 1; } }
    .aura-dot { position: absolute; background-color: var(--c-dot); opacity: 0; border: 1px solid rgba(0,0,0,0.1); animation: driftOut linear infinite; }
    .aura-dot.sq { border-radius: 2px; }
    @keyframes driftOut { 0% { transform: translate(0, 0) scale(0.2); opacity: 0; } 10% { opacity: 0.8; } 100% { transform: translate(var(--tx), var(--ty)) scale(1.2); opacity: 0; } }

    .particle { position: fixed; pointer-events: none; z-index: 10001; border-radius: 50%; }
    .particle.square { border-radius: 2px; }

    .empty-msg { text-align: center; color: var(--c-grey); font-weight: 800; padding: 40px 20px; border: 2px dashed var(--outline); border-radius: 16px; animation: fadeInMsg 0.5s ease-out; background: var(--empty-bg); }
    @keyframes fadeInMsg { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .history-years { display: flex; gap: 10px; overflow-x: auto; padding: 10px 4px 15px 4px; margin-bottom: 10px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
    .history-years::-webkit-scrollbar { display: none; }
    .year-chip { padding: 8px 16px; border-radius: 20px; border: 2px solid var(--outline); background: var(--card); font-weight: 900; font-size: 14px; cursor: pointer; white-space: nowrap; color: var(--text); transition: all 0.2s; flex-shrink: 0; }
    .year-chip:hover { transform: translateY(-2px); box-shadow: 4px 4px 0 var(--shadow-col); }
    .year-chip.selected { background: var(--text); color: var(--bg-base); transform: translateY(2px); box-shadow: none;}
    
    .history-stats { display: flex; gap: 10px; margin-bottom: 15px; font-size: 13px; font-weight: 800; color: var(--c-grey); justify-content: center; flex-wrap: wrap; }
    .stat-pill { display: flex; align-items: center; gap: 8px; background: var(--input-bg); padding: 6px 12px; border-radius: 12px; border: 2px solid var(--outline); }
    .stat-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; border: 1px solid rgba(0,0,0,0.1); }

    .history-list { display: flex; flex-direction: column; gap: 8px; }
    .h-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; border: 2px solid var(--outline); border-radius: 12px; background: var(--card); animation: fadeInHistory 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
    .h-item.hard { border-color: var(--c-red); background: rgba(255, 118, 117, 0.15); }
    [data-theme="dark"] .h-item.hard { background: rgba(255, 118, 117, 0.25); }
    @keyframes fadeInHistory { to { opacity: 1; transform: translateY(0); } }
    .h-left { display: flex; flex-direction: column; }
    .h-date { font-size: 11px; color: var(--c-grey); font-weight: 700; margin-bottom: 2px; }
    .h-txt { font-weight: 800; font-size: 14px; color: var(--text); }
    .h-right { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
    .h-dur { font-size: 10px; font-weight: 900; color: var(--c-grey); background: var(--bg-base); padding: 2px 6px; border-radius: 6px; }
    .h-dot { width: 8px; height: 8px; border-radius: 50%; box-shadow: 0 0 4px currentColor; }

    .controls { margin-top: 30px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
  </style>
</head>
<body>

<canvas id="starfield"></canvas>

<div id="login-overlay">
  <div class="login-box">
    <div class="login-title">TO-DO LIST</div>
    <div style="font-weight: 800; color: var(--c-grey);">CONNEXION REQUISE</div>
    <button class="btn-login" onclick="login()">Se connecter (Google)</button>
  </div>
</div>

<div class="app" id="app">
  
  <div class="card header">
    <div class="title-row">
      <h1>To-Do</h1>
      <div class="user-controls">
        <div class="theme-toggle btn-icon" onclick="toggleTheme()" title="Mode Nuit/Jour">üåì</div>
        <div class="theme-toggle btn-icon" onclick="logout()" title="D√©connexion">üö™</div>
      </div>
    </div>
    <div class="tabs">
      <button id="tab-tasks" class="btn tab active" onclick="nav('tasks')">Missions</button>
      <button id="tab-history" class="btn tab" onclick="nav('history')">Archives</button>
    </div>
  </div>

  <div id="page-tasks" class="page active">
    <div class="card">
      
      <form class="input-row" onsubmit="event.preventDefault(); add();">
        <input type="text" id="inp" class="task-input" placeholder="Nouvelle mission..." autocomplete="off" />
        <div class="actions-row">
          <div class="lvl-select">
            <div class="lvl-btn l1 active" onclick="setLvl(1)"></div>
            <div class="lvl-btn l2" onclick="setLvl(2)"></div>
            <div class="lvl-btn l3" onclick="setLvl(3)"></div>
          </div>
          <button type="submit" class="btn btn-add">GO</button>
        </div>
      </form>

      <div id="list" class="list-container"></div>
    </div>
  </div>

  <div id="page-history" class="page">
    <div class="card">
      <div id="history-content"></div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDn0f67RRq48f_oJMn07PO5_RFkd1o15-c",
    authDomain: "todolist-f1ea8.firebaseapp.com",
    databaseURL: "https://todolist-f1ea8-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "todolist-f1ea8",
    storageBucket: "todolist-f1ea8.firebasestorage.app",
    messagingSenderId: "54632201976",
    appId: "1:54632201976:web:ec4c9785dc9846d4d4c50d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  let tasks = [];
  let currentLvl = 1;
  let currentUser = null;
  let unsubscribeDB = null;

  // --- AUDIO CONFIG ---
  const katanaSound = new Audio('SFX_Feedback_Hit_Weakness_06.wav');
  katanaSound.volume = 0.5;
  const whipSound = new Audio('tinyWhip.wav');
  whipSound.volume = 0.5;

  function playKatanaSound() {
      katanaSound.currentTime = 0;
      katanaSound.play().catch(() => {});
  }

  function playWhipSound() {
      whipSound.currentTime = 0;
      whipSound.play().catch(() => {});
  }

  // --- AUTHENTIFICATION ---
  window.login = function() { signInWithPopup(auth, provider).catch(err => alert("Erreur: " + err.message)); }
  window.logout = function() { signOut(auth).then(() => window.location.reload()); }

  onAuthStateChanged(auth, (user) => {
    const overlay = document.getElementById('login-overlay');
    const appUI = document.getElementById('app');
    if (user) {
      currentUser = user;
      overlay.style.opacity = '0';
      setTimeout(() => { overlay.style.display = 'none'; appUI.classList.add('visible'); }, 500);
      const userTasksRef = ref(db, `users/${user.uid}/todos`);
      unsubscribeDB = onValue(userTasksRef, (snapshot) => {
        const data = snapshot.val();
        tasks = data ? data : [];
        renderList(false);
        if(document.getElementById('page-history').classList.contains('active')) renderHistory();
      });
    } else {
      currentUser = null;
      overlay.style.display = 'flex';
      overlay.style.opacity = '1';
      appUI.classList.remove('visible');
      if (unsubscribeDB) unsubscribeDB();
    }
  });

  function saveToCloud() {
    if (!currentUser) return;
    const userTasksRef = ref(db, `users/${currentUser.uid}/todos`);
    set(userTasksRef, tasks);
  }

  window.toggleTheme = function() {
    playWhipSound();
    const el = document.documentElement;
    const next = el.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    el.setAttribute('data-theme', next);
    localStorage.setItem('kurz_theme', next);
    drawStars();
  }

  const canvas = document.getElementById('starfield');
  const ctx = canvas.getContext('2d');
  let stars = [];
  const isMobile = window.innerWidth < 600;
  const numStars = isMobile ? 80 : 150; 
  let width, height;

  function resizeCanvas() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; initStars(); }
  class Star {
      constructor() { this.x = Math.random() * width; this.y = Math.random() * height; this.size = Math.random() < 0.9 ? Math.random() * 1.5 : Math.random() * 2 + 1.5; this.baseAlpha = Math.random() * 0.6 + 0.2; this.twinkleSpeed = Math.random() * 0.005 + 0.002; this.twinkleOffset = Math.random() * 100; this.dx = (Math.random() - 0.5) * 0.05; this.dy = (Math.random() - 0.5) * 0.05; }
      update() { this.x += this.dx; this.y += this.dy; if (this.x < 0) this.x = width; if (this.x > width) this.x = 0; if (this.y < 0) this.y = height; if (this.y > height) this.y = 0; }
      draw() { const time = Date.now(); const twinkle = Math.sin(time * this.twinkleSpeed + this.twinkleOffset); const alpha = Math.max(0.1, Math.min(1, this.baseAlpha + twinkle * 0.2)); const rgb = getComputedStyle(document.body).getPropertyValue('--star-color').trim(); ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fillStyle = `rgba(${rgb}, ${alpha})`; ctx.shadowBlur = this.size * 3; ctx.shadowColor = `rgba(${rgb}, ${alpha})`; ctx.fill(); ctx.shadowBlur = 0; }
  }
  function initStars() { stars = []; for(let i=0; i<numStars; i++) stars.push(new Star()); }
  function animateStars() { ctx.clearRect(0, 0, width, height); stars.forEach(s => { s.update(); s.draw(); }); requestAnimationFrame(animateStars); }
  window.drawStars = function() { ctx.clearRect(0, 0, width, height); stars.forEach(s => s.draw()); }
  window.addEventListener('resize', resizeCanvas); resizeCanvas(); animateStars();

  window.nav = function(p) {
    playWhipSound();
    document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
    document.getElementById('page-'+p).classList.add('active');
    document.getElementById('tab-'+p).classList.add('active');
    if (p === 'history') renderHistory();
  }

  window.setLvl = function(n) {
    playWhipSound();
    currentLvl = n;
    document.querySelectorAll('.lvl-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.lvl-btn')[n-1].classList.add('active');
  }

  // Fonction Add avec gestion formulaire + son
  window.add = function() {
    playWhipSound();
    const inp = document.getElementById('inp'); const txt = inp.value.trim();
    if (!txt) return;
    const newTask = { id: Date.now(), txt: txt, lvl: currentLvl, created: Date.now(), done: null };
    if (!Array.isArray(tasks)) tasks = [];
    tasks.push(newTask);
    saveToCloud();
    inp.value = ''; 
    inp.blur(); // Ferme le clavier sur mobile
  }

  function renderList(animateLast = false) {
    const box = document.getElementById('list');
    const safeTasks = Array.isArray(tasks) ? tasks : [];
    const activeTasks = safeTasks.filter(t => !t.done).sort((a,b) => b.created - a.created);
    box.innerHTML = '';
    if (activeTasks.length === 0) { box.innerHTML = `<div class="empty-msg">Aucune mission en cours.<br>Profites-en pour explorer ! üöÄ</div>`; return; }
    activeTasks.forEach(t => box.appendChild(createTaskElement(t, false)));
  }

  function getAuraHTML(level) {
    const color = level === 1 ? 'var(--c-green)' : (level === 2 ? 'var(--c-yellow)' : 'var(--c-red)');
    let htmlBase = '', htmlTurbo = '';
    const baseCount = isMobile ? 8 : 15; const turboCount = isMobile ? 15 : 30;
    const makeDot = (isTurbo) => {
      const side = Math.floor(Math.random() * 4); let top, left, tx, ty;
      const spread = (isTurbo ? 65 : 35) + Math.random() * 20;
      if(side === 0) { top = "0%"; left = Math.random()*100+"%"; tx = (Math.random()-0.5)*20; ty = -spread; }
      else if (side === 1) { top = Math.random()*100+"%"; left = "100%"; tx = spread; ty = (Math.random()-0.5)*20; }
      else if (side === 2) { top = "100%"; left = Math.random()*100+"%"; tx = (Math.random()-0.5)*20; ty = spread; }
      else { top = Math.random()*100+"%"; left = "0%"; tx = -spread; ty = (Math.random()-0.5)*20; }
      const delay = Math.random() * 2 + 's'; const duration = (1.5 + Math.random() * 2) + 's'; const shape = Math.random() > 0.6 ? 'sq' : 'rd'; const size = 8 + Math.random() * 6;
      return `<div class="aura-dot ${shape}" style="top:${top}; left:${left}; width:${size}px; height:${size}px; --tx:${tx}px; --ty:${ty}px; animation-delay:-${delay}; animation-duration:${duration};"></div>`;
    };
    for(let i=0; i<baseCount; i++) htmlBase += makeDot(false);
    for(let i=0; i<turboCount; i++) htmlTurbo += makeDot(true);
    return `<div class="aura-container aura-base" style="--c-dot: ${color}">${htmlBase}</div><div class="aura-container aura-turbo" style="--c-dot: ${color}">${htmlTurbo}</div>`;
  }

  function createTaskElement(t, isNew) {
    const el = document.createElement('div'); el.className = isNew ? 'task-item new-entry' : 'task-item'; el.id = 'task-' + t.id;
    let badgeColor = t.lvl===1 ? 'var(--c-green)' : (t.lvl===2 ? 'var(--c-yellow)' : 'var(--c-red)');
    let badgeTxt = t.lvl===1 ? 'Easy' : (t.lvl===2 ? 'Medium' : 'Hard');
    const aura = getAuraHTML(t.lvl);
    el.innerHTML = `${aura}
      <div class="check-box" onclick="check(${t.id}, this)"><svg viewBox="0 0 24 24" fill="none"><path d="M20 6L9 17L4 12"></path></svg></div>
      <div class="task-txt">${escape(t.txt)}</div>
      <div class="task-tag" style="background:${badgeColor}">${badgeTxt}</div>`;
    return el;
  }

  window.check = function(id, btn) {
    const row = document.getElementById('task-' + id); if(!row) return;
    playKatanaSound(); btn.classList.add('checked');
    const rect = row.getBoundingClientRect();
    document.getElementById('app').classList.remove('shake'); void document.getElementById('app').offsetWidth; document.getElementById('app').classList.add('shake');
    const cloneTop = row.cloneNode(true); const cloneBot = row.cloneNode(true);
    [cloneTop, cloneBot].forEach(c => {
      c.id = ""; c.classList.remove('new-entry'); c.style.margin = "0";
      c.style.width = rect.width + "px"; c.style.height = rect.height + "px";
      c.style.position = "fixed"; c.style.left = rect.left + "px"; c.style.top = rect.top + "px";
      c.style.transition = "transform 0.5s ease-in, opacity 0.5s ease-in";
    });
    cloneTop.style.clipPath = "polygon(-100% -100%, 200% -100%, 200% 45%, -100% 55%)";
    cloneBot.style.clipPath = "polygon(-100% 55%, 200% 45%, 200% 200%, -100% 200%)";
    document.body.appendChild(cloneTop); document.body.appendChild(cloneBot);
    row.classList.add('cut-hidden');
    spawnSlashLine(rect, -3); spawnParticles(rect.left + rect.width/2, rect.top + rect.height/2, true);
    requestAnimationFrame(() => {
        void cloneTop.offsetWidth;
        cloneTop.style.transform = "translate(-40px, -20px) rotate(-3deg)"; cloneTop.style.opacity = "0";
        cloneBot.style.transform = "translate(40px, 50px) rotate(3deg)"; cloneBot.style.opacity = "0";
    });
    setTimeout(() => { row.classList.add('collapsed'); }, 300);
    setTimeout(() => {
      cloneTop.remove(); cloneBot.remove();
      const tIndex = tasks.findIndex(x => x.id === id);
      if (tIndex > -1) { tasks[tIndex].done = Date.now(); saveToCloud(); }
    }, 850);
  }

  function spawnSlashLine(rect, angleDeg) {
    const flash = document.createElement('div'); flash.className = 'slash-flash';
    const w = Math.sqrt(rect.width*rect.width + rect.height*rect.height) * 1.2;
    flash.style.width = w + 'px'; flash.style.left = (rect.left - 20) + 'px'; flash.style.top = (rect.top + rect.height/2) + 'px';
    flash.style.transform = `rotate(${angleDeg}deg)`; document.body.appendChild(flash);
    const anim = flash.animate([{transform:`rotate(${angleDeg}deg) scaleX(0)`, opacity:0.5}, {transform:`rotate(${angleDeg}deg) scaleX(1)`, opacity:1, offset:0.2}, {transform:`rotate(${angleDeg}deg) scaleX(1)`, opacity:0}], {duration:300, easing:'ease-out'});
    anim.onfinish = () => flash.remove();
  }

  function spawnParticles(x, y, isLine = false) {
    const colors = ['#00cec9', '#fdcb6e', '#ff7675', '#00b894', '#f5f6fa'];
    const particleCount = isMobile ? (isLine ? 15 : 10) : (isLine ? 30 : 20);
    for (let i = 0; i < particleCount; i++) {
      const p = document.createElement('div'); p.classList.add('particle');
      if (Math.random() > 0.5) p.classList.add('square');
      p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      const size = Math.random() * 10 + 6; p.style.width = size + 'px'; p.style.height = size + 'px';
      let startX = x, startY = y;
      if (isLine) { startX = x + (Math.random()-0.5)*300; startY = y + (Math.random()-0.5)*20; }
      p.style.left = startX + 'px'; p.style.top = startY + 'px'; document.body.appendChild(p);
      const angle = Math.random() * Math.PI * 2; const velocity = Math.random() * 10 + 5;
      let vx = Math.cos(angle) * velocity; let vy = Math.sin(angle) * velocity; let life = 1;
      function update() {
        life -= 0.03; vx *= 0.9; vy *= 0.9; vy += 0.8;
        p.style.left = (parseFloat(p.style.left) + vx) + 'px'; p.style.top = (parseFloat(p.style.top) + vy) + 'px';
        p.style.opacity = life; p.style.transform = `scale(${life})`;
        if (life > 0) requestAnimationFrame(update); else p.remove();
      }
      requestAnimationFrame(update);
    }
  }

  function formatDuration(ms) {
    const min = Math.floor(ms / 60000); if (min < 60) return min + 'm';
    const h = Math.floor(min / 60); if (h < 24) return h + 'h ' + (min%60) + 'm';
    return Math.floor(h/24) + 'j ' + (h%24) + 'h';
  }

  window.renderHistory = function() {
    const box = document.getElementById('history-content'); box.innerHTML = '';
    const safeTasks = Array.isArray(tasks) ? tasks : [];
    const doneTasks = safeTasks.filter(t => t.done).sort((a,b) => b.done - a.done);
    if (doneTasks.length === 0) { box.innerHTML = `<div class="empty-msg">L'historique est vide.</div>`; return; }
    
    const years = [...new Set(doneTasks.map(t => new Date(t.done).getFullYear()))];
    years.sort((a,b) => b - a);
    let currentYearView = null;
    if (!currentYearView || !years.includes(currentYearView)) currentYearView = years[0];

    const yearTasks = doneTasks.filter(t => new Date(t.done).getFullYear() === currentYearView);
    const s1 = yearTasks.filter(t => t.lvl===1).length;
    const s2 = yearTasks.filter(t => t.lvl===2).length;
    const s3 = yearTasks.filter(t => t.lvl===3).length;

    const yearsBar = document.createElement('div'); yearsBar.className = 'history-years';
    years.forEach(y => {
      const chip = document.createElement('div'); chip.className = `year-chip ${y === currentYearView ? 'selected' : ''}`;
      chip.innerText = y; 
      chip.onclick = () => { 
          const listDiv = document.querySelector('.history-list');
          if(listDiv) listDiv.remove();
          const statsDiv = document.querySelector('.history-stats');
          if(statsDiv) statsDiv.remove();
          renderHistoryYear(y, doneTasks, box);
          document.querySelectorAll('.year-chip').forEach(c => c.classList.remove('selected'));
          chip.classList.add('selected');
      };
      yearsBar.appendChild(chip);
    });
    box.appendChild(yearsBar);

    const stats = document.createElement('div'); stats.className = 'history-stats';
    stats.innerHTML = `
      <div class="stat-pill" style="color:var(--c-green)"><span class="stat-dot" style="background:var(--c-green)"></span> ${s1}</div>
      <div class="stat-pill" style="color:var(--c-yellow)"><span class="stat-dot" style="background:var(--c-yellow)"></span> ${s2}</div>
      <div class="stat-pill" style="color:var(--c-red)"><span class="stat-dot" style="background:var(--c-red)"></span> ${s3}</div>
    `;
    box.appendChild(stats);

    const listDiv = document.createElement('div'); listDiv.className = 'history-list';
    yearTasks.forEach((t, i) => {
      const d = new Date(t.done);
      const row = document.createElement('div');
      row.className = `h-item ${t.lvl === 3 ? 'hard' : ''}`;
      row.style.animationDelay = (i * 0.05) + 's';
      let color = t.lvl===1 ? 'var(--c-green)' : (t.lvl===2 ? 'var(--c-yellow)' : 'var(--c-red)');
      let dur = t.created ? formatDuration(t.done - t.created) : '?';
      row.innerHTML = `
        <div class="h-left">
          <div class="h-date">${d.toLocaleDateString('fr-FR', {day:'numeric', month:'long', hour:'2-digit', minute:'2-digit'})}</div>
          <div class="h-txt">${escape(t.txt)}</div>
        </div>
        <div class="h-right">
          <div class="h-dur">‚è± ${dur}</div>
          <div class="h-dot" style="background:${color}; box-shadow:0 0 6px ${color}"></div>
        </div>
      `;
      listDiv.appendChild(row);
    });
    box.appendChild(listDiv);
  }

  function renderHistoryYear(year, allDoneTasks, container) {
      const yearTasks = allDoneTasks.filter(t => new Date(t.done).getFullYear() === year);
      const s1 = yearTasks.filter(t => t.lvl===1).length;
      const s2 = yearTasks.filter(t => t.lvl===2).length;
      const s3 = yearTasks.filter(t => t.lvl===3).length;

      const stats = document.createElement('div'); stats.className = 'history-stats';
      stats.innerHTML = `
        <div class="stat-pill" style="color:var(--c-green)"><span class="stat-dot" style="background:var(--c-green)"></span> ${s1}</div>
        <div class="stat-pill" style="color:var(--c-yellow)"><span class="stat-dot" style="background:var(--c-yellow)"></span> ${s2}</div>
        <div class="stat-pill" style="color:var(--c-red)"><span class="stat-dot" style="background:var(--c-red)"></span> ${s3}</div>
      `;
      container.appendChild(stats);

      const listDiv = document.createElement('div'); listDiv.className = 'history-list';
      yearTasks.forEach((t, i) => {
        const d = new Date(t.done);
        const row = document.createElement('div');
        row.className = `h-item ${t.lvl === 3 ? 'hard' : ''}`;
        row.style.animationDelay = (i * 0.05) + 's';
        let color = t.lvl===1 ? 'var(--c-green)' : (t.lvl===2 ? 'var(--c-yellow)' : 'var(--c-red)');
        let dur = t.created ? formatDuration(t.done - t.created) : '?';
        row.innerHTML = `
          <div class="h-left">
            <div class="h-date">${d.toLocaleDateString('fr-FR', {day:'numeric', month:'long', hour:'2-digit', minute:'2-digit'})}</div>
            <div class="h-txt">${escape(t.txt)}</div>
          </div>
          <div class="h-right">
            <div class="h-dur">‚è± ${dur}</div>
            <div class="h-dot" style="background:${color}; box-shadow:0 0 6px ${color}"></div>
          </div>
        `;
        listDiv.appendChild(row);
      });
      container.appendChild(listDiv);
  }

  function escape(s) { return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
</script>

</body>
</html>